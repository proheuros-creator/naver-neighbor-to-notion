// neighbor-activity/index.js

const axios = require("axios");
const cheerio = require("cheerio");
const fs = require("fs").promises;
const { baseId, maxPages, delayMs } = require("./config");

const UA =
  "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";

const FOLLOWINGS_BASE =
  "https://section.blog.naver.com/connect/ViewMoreFollowings.naver";

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

/**
 * groups.js (ESM) Î°úÎìú
 * - export const GROUPS = [ { id, name }, ... ]
 * - neighbor-activity Í∏∞Ï§Ä ÏÉÅÏúÑ Ìè¥Îçî(../groups.js)Ïóê ÏûàÎã§Í≥† Í∞ÄÏ†ï
 */
async function loadGroups() {
  try {
    const mod = await import("../groups.js");
    const arr = Array.isArray(mod.GROUPS) ? mod.GROUPS : [];
    const map = {};
    for (const g of arr) {
      if (!g || g.id == null) continue;
      map[String(g.id)] = g.name || "";
    }
    return { groupList: arr, groupMap: map };
  } catch (e) {
    console.log("‚ö†Ô∏è groups.js Î°úÎìú Ïã§Ìå® (Í∑∏Î£π Ï†ïÎ≥¥ ÏóÜÏù¥ ÏßÑÌñâ):", e.message);
    return { groupList: [], groupMap: {} };
  }
}

/**
 * hrefÏóêÏÑú blogId Ï∂îÏ∂ú: https://blog.naver.com/{id}
 */
function extractBlogId(href) {
  if (!href) return null;
  const m = href.match(/^https?:\/\/blog\.naver\.com\/([A-Za-z0-9_-]+)/);
  return m ? m[1] : null;
}

/**
 * ViewMoreFollowings HTMLÏóêÏÑú Ïù¥ÏõÉ Ï∂îÍ∞Ä
 * - groupIdOrNull ÏûàÏúºÎ©¥ Ìï¥Îãπ Í∑∏Î£π ÏÜåÏÜçÏúºÎ°úÎèÑ Í∏∞Î°ù
 */
function collectFromFollowingsHtml(html, neighborsMap, groupIdOrNull) {
  const $ = cheerio.load(html);

  $("a[href*='blog.naver.com/']").each((_, el) => {
    const href = $(el).attr("href");
    const blogId = extractBlogId(href);
    if (!blogId) return;

    if (!neighborsMap.has(blogId)) {
      neighborsMap.set(blogId, {
        blogId,
        blogUrl: `https://blog.naver.com/${blogId}`,
        groupIds: new Set()
      });
    }

    if (groupIdOrNull != null) {
      neighborsMap
        .get(blogId)
        .groupIds.add(String(groupIdOrNull));
    }
  });
}

/**
 * ViewMoreFollowings ÌéòÏù¥ÏßÄ Ìò∏Ï∂ú
 */
async function fetchFollowingsPage({ page, groupId }) {
  const cookie = process.env.NAVER_COOKIE || "";
  const params = new URLSearchParams();
  params.set("blogId", baseId);
  params.set("currentPage", String(page));
  if (groupId != null) params.set("groupId", String(groupId));

  const url = `${FOLLOWINGS_BASE}?${params.toString()}`;

  const res = await axios.get(url, {
    headers: {
      "User-Agent": UA,
      Cookie: cookie
    }
  });

  return res.data;
}

/**
 * 1Îã®Í≥Ñ: Ï†ÑÏ≤¥ Ïù¥ÏõÉ ÏàòÏßë (groupId ÏóÜÏù¥)
 */
async function collectAllNeighbors() {
  const neighbors = new Map();

  for (let page = 1; page <= maxPages; page++) {
    console.log(
      `üì• [ALL] Fetch neighbors page ${page}`
    );
    let html;
    try {
      html = await fetchFollowingsPage({ page, groupId: null });
    } catch (e) {
      console.warn(
        `   ‚ö†Ô∏è [ALL] Page ${page} load failed: ${e.message}`
      );
      break;
    }

    const before = neighbors.size;
    collectFromFollowingsHtml(html, neighbors, null);
    const added = neighbors.size - before;

    console.log(
      `   üë• [ALL] Total: ${neighbors.size} (page ${page}, +${added})`
    );

    if (page > 1 && added === 0) {
      console.log("   ‚õî [ALL] No new neighbors. Stop.");
      break;
    }

    await sleep(delayMs);
  }

  return neighbors;
}

/**
 * 2Îã®Í≥Ñ: groups.js Í∏∞Ï§Ä Í∑∏Î£π Î©§Î≤ÑÏã≠ Ï±ÑÏö∞Í∏∞
 */
async function enrichWithGroups(neighbors, groupList) {
  if (!groupList.length) {
    console.log("‚ö†Ô∏è Í∑∏Î£π Ï†ïÏùòÍ∞Ä ÏóÜÏñ¥ groupId Îß§ÌïëÏùÄ ÏÉùÎûµÌï©ÎãàÎã§.");
    return;
  }

  console.log(
    `üîé Í∑∏Î£π Î©§Î≤ÑÏã≠ Ïä§Ï∫î (GROUPS: ${groupList
      .map((g) => `${g.id}:${g.name}`)
      .join(", ")})`
  );

  for (const g of groupList) {
    const gid = g.id;
    for (let page = 1; page <= maxPages; page++) {
      console.log(
        `üì• [GROUP ${gid}] ${g.name} - page ${page}`
      );

      let html;
      try {
        html = await fetchFollowingsPage({ page, groupId: gid });
      } catch (e) {
        console.warn(
          `   ‚ö†Ô∏è [GROUP ${gid}] Page ${page} load failed: ${e.message}`
        );
        break;
      }

      const before = countGroupMembers(neighbors, gid);
      collectFromFollowingsHtml(html, neighbors, gid);
      const after = countGroupMembers(neighbors, gid);
      const added = after - before;

      console.log(
        `   üë• [GROUP ${gid}] members: ${after} (page ${page}, +${added})`
      );

      if (page > 1 && added === 0) {
        console.log(
          `   ‚õî [GROUP ${gid}] No new members. Stop.`
        );
        break;
      }

      await sleep(delayMs);
    }
  }
}

function countGroupMembers(neighbors, gid) {
  const key = String(gid);
  let cnt = 0;
  for (const n of neighbors.values()) {
    if (n.groupIds.has(key)) cnt++;
  }
  return cnt;
}

/**
 * 3Îã®Í≥Ñ: Ïù∏ÌîåÎ£®Ïñ∏ÏÑú Ïó¨Î∂Ä ÌôïÏù∏
 * Ïù∏ÌîåÎ£®Ïñ∏ÏÑú Ïó¨Î∂Ä & Ïù∏ÌîåÎ£®Ïñ∏ÏÑú ID/URL ÌÉêÏßÄ
 *
 * Ïö∞ÏÑ†ÏàúÏúÑ:
 *  1) Î∏îÎ°úÍ∑∏ HTML ÏïàÏóêÏÑú in.naver.com/{handle} ÎßÅÌÅ¨ Ï∞æÍ∏∞
 *  2) ÏóÜÏúºÎ©¥ in.naver.com/{blogId} ÏßÅÏ†ë ÌôïÏù∏ (ÎèôÏùº IDÏù∏ ÏºÄÏù¥Ïä§Ïö©)
 */
async function detectInfluencerForBlog(blogId) {
  const blogUrl = `https://blog.naver.com/${blogId}`;
  let influencerId = null;

  // 1Ï∞®: Î∏îÎ°úÍ∑∏ Î©îÏù∏ HTMLÏóêÏÑú in.naver.com ÎßÅÌÅ¨ ÌÉêÏÉâ
  try {
    const res = await axios.get(blogUrl, {
      maxRedirects: 5,
      headers: { "User-Agent": UA }
    });

    const html = res.data;
    const $ = cheerio.load(html);

    // a ÌÉúÍ∑∏ hrefÏóêÏÑú in.naver.com/{handle} Ï∞æÍ∏∞
    $("a[href*='in.naver.com/']").each((_, el) => {
      if (influencerId) return; // Ï≤´ Î≤àÏß∏Îßå ÏÇ¨Ïö©
      let href = $(el).attr("href") || "";
      if (!href) return;

      if (href.startsWith("//")) href = "https:" + href;
      if (!href.startsWith("http")) {
        // ÏÉÅÎåÄÍ≤ΩÎ°ú ÎπÑÏä∑ÌïòÎ©¥ Ïä§ÌÇµ
        return;
      }

      const m = href.match(/in\.naver\.com\/([^\/\?\s]+)/);
      if (m && m[1]) {
        const handle = m[1].trim();
        // ÎÑàÎ¨¥ ÏßßÍ±∞ÎÇò Ïù¥ÏÉÅÌïú Í∞í ÌïÑÌÑ∞ÎßÅ Í∞ÄÎä•ÌïòÏßÄÎßå ÏùºÎã® Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
        influencerId = handle;
      }
    });

    // ÌòπÏãú HTML ÏïàÏóê 'Ïù∏ÌîåÎ£®Ïñ∏ÏÑú' / 'Influencer' Í¥ÄÎ†® ÌëúÏãúÎßå ÏûàÏñ¥ÎèÑ
    // (Í∑ºÎç∞ handleÏù¥ ÏóÜÏúºÎ©¥ Îß§ÌïëÏùÑ Î™ª ÌïòÎãàÍπå Ïó¨Í∏∞ÏÑúÎäî YÎßå Ï£ºÍ≥† IDÎäî ÎπÑÏõåÎëò ÏàòÎèÑ ÏûàÏùå)
    if (!influencerId) {
      if (
        html.includes("in.naver.com") &&
        (html.includes("Ïù∏ÌîåÎ£®Ïñ∏ÏÑú") ||
          html.toLowerCase().includes("influencer"))
      ) {
        // ÎßÅÌÅ¨Îäî ÏûàÎäîÎç∞ ÌååÏã±ÏùÑ Î™ªÌïú ÌäπÏù¥ ÏºÄÏù¥Ïä§Ïùº Ïàò ÏûàÏúºÎØÄÎ°ú
        // ÏùºÎã® isInfluencer=YÎ°úÎßå Ï≤òÎ¶¨ÌïòÍ≥†, idÎäî ÎπÑÏõåÎëò ÏàòÎèÑ ÏûàÎã§.
        return {
          isInfluencer: "Y",
          influencerId: "",
          influencerUrl: ""
        };
      }
    }
  } catch (e) {
    // Î∏îÎ°úÍ∑∏ Î°úÎî© Ïã§Ìå® Ïãú, ÏïÑÎûò fallbackÎßå ÏÇ¨Ïö©
  }

  // 2Ï∞®: Í∑∏ÎûòÎèÑ Î™ª Ï∞æÏïòÍ≥†, blogIdÏôÄ Ïù∏Ìîå IDÍ∞Ä ÎèôÏùºÌïú ÏºÄÏù¥Ïä§Î•º Ïª§Î≤ÑÌïòÍ≥† Ïã∂ÏúºÎ©¥
  if (!influencerId) {
    const candidate = blogId;
    const url = `https://in.naver.com/${candidate}`;
    try {
      const res = await axios.get(url, {
        maxRedirects: 0,
        validateStatus: (s) => s === 200 || (s >= 300 && s < 400),
        headers: { "User-Agent": UA }
      });

      if (res.status === 200) {
        const body =
          typeof res.data === "string"
            ? res.data
            : (res.data || "").toString();

        if (
          body.includes("Ïù∏ÌîåÎ£®Ïñ∏ÏÑú") ||
          body.toLowerCase().includes("influencer") ||
          body.includes("in.naver.com")
        ) {
          influencerId = candidate;
        }
      }
    } catch (e) {
      // 404 Îì±ÏùÄ Í∑∏ÎÉ• N
    }
  }

  if (influencerId) {
    return {
      isInfluencer: "Y",
      influencerId,
      influencerUrl: `https://in.naver.com/${influencerId}`
    };
  }

  return {
    isInfluencer: "N",
    influencerId: "",
    influencerUrl: ""
  };
}

/**
 * Î©îÏù∏
 */
async function main() {
  try {
    const { groupList, groupMap } = await loadGroups();

    // 1) Ï†ÑÏ≤¥ Ïù¥ÏõÉ
    const neighborsMap = await collectAllNeighbors();

    // 2) Í∑∏Î£π Î©§Î≤ÑÏã≠
    await enrichWithGroups(neighborsMap, groupList);
    
    // 3) Ïù∏ÌîåÎ£®Ïñ∏ÏÑú Ïó¨Î∂Ä + Ïù∏ÌîåÎ£®Ïñ∏ÏÑú ID/URL
    const neighbors = Array.from(neighborsMap.values());
    for (let i = 0; i < neighbors.length; i++) {
      const n = neighbors[i];
      console.log(
        `‚≠ê [${i + 1}/${neighbors.length}] Detect influencer for: ${n.blogId}`
      );
      const info = await detectInfluencerForBlog(n.blogId);
      n.isInfluencer = info.isInfluencer;
      n.influencerId = info.influencerId;
      n.influencerUrl = info.influencerUrl;
      await sleep(300);
    }

    // 4) CSV ÏÉùÏÑ±
    const header =
      "blogId,blogUrl,groupIds,groupNames,isInfluencer,influencerId,influencerUrl\n";

    const lines = neighbors.map((n) => {
      const gids = Array.from(n.groupIds || []);
      const gnames = gids
        .map((id) => groupMap[id] || "")
        .filter(Boolean)
        .join("|");

      return [
        n.blogId,
        n.blogUrl,
        gids.join("|"),
        gnames,
        n.isInfluencer || "N",
        n.influencerId || "",
        n.influencerUrl || ""
      ]
        .map((v) =>
          v != null ? String(v).replace(/"/g, '""') : ""
        )
        .map((v) => `"${v}"`)
        .join(",");
    });

    const csv = header + lines.join("\n");
    await fs.writeFile(
      "neighbor-followings-result.csv",
      csv,
      "utf8"
    );
    console.log("‚úÖ Done. neighbor-followings-result.csv ÏÉùÏÑ± ÏôÑÎ£å");
  } catch (e) {
    console.error("‚ùå Error:", e.message);
    process.exit(1);
  }
}

main();
